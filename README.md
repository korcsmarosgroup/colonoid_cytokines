# Colonoid cytokine transcriptomics

This repository holds the code and necessary input files relating to the network analysis part of the colonoid cytokine project of Nick Powell and his group in Kings College London (2019). The analysis was carried out by Agatha Treveil and supervised by Tamas Korcsmaros (Earlham and Quadram Institutes, Norwich) in collaboration with Nick Powell and Polychronis Pavlidis. The paper is available...?

In brief, colonoids were grown from healthy human colon biopses. Whole organoid transcriptomics data was obtained from colonoids treated seperately with 4 cytokines (Il13, IL17, IFNg and TNFa), as well as from untreated colonoids. The initial analysis of the transcriptomics data was carried out at Kings, generating lists of differentially expressed genes (cytokine treated vs naive colonoids) with corresponding expression values for each gene in each colonoid (FPKM values). This data was passed to the Korcsmaros group for network analysis. Network analysis generated causal networks linking the applied cytokine to it's affected genes via signalling pathways to transcription factors and then trancription factor regulation of differentially expressed genes.

The code and input files contained in this repository (described below) are grouped by function and should (on the whole) be carried out in the order written below. 

## **--Prepare prior knowledge--**

Two prior knowledge networks are used in the analysis: OmniPath for signalling pathways (protein - protein interactions) and DoRothEA for regulatory connections (Transcription factors (TFs) - target genes (TGs)).

### OmniPath

OmniPath version 0.7.111 was obtained in a TSV format in May 2019. It was was prepared for analysis by the removal of any interactions between one of the applied cytokines and a protein which is not known to be a cell surface receptor. This knowledge was obtained through literature searches. The following cytokine receptors were kept (all others were removed manually):

	IFNg (P01579) -> IFNGR1, IFNGR2 (P15260, P38484)
	IL17 (Q16552) -> IL17RA, IL17RC (Q96F46, Q8NAC3)
	TNFa (P01375) -> TNFRSF1A, TNFRSF1B (P19438, P20333)
	IL13 (P35225) -> IL13RA1, IL13RA2 (P78552, Q14627)

Additionally a few other interactions had to be removed as there were connections between IL13RA and other receptors which resulted in downstream signalling which would not normally happen following IL13 signalling. The interactions removed (manually) were:

	IL13RA1 (P78552) -> IL2RG (P31785)
	IL13RA1 (P78552) -> IL4R (P24394)

The resulting OmniPath file is located here: *input_data/prior_knowledge_networks/omnipath_0.7.111_formatted_cytokinereceptors.tsv*

### DoRothEA

All interactions with confidence levels A-D from DoRothEA v2 were downloaded from http://saezlab.org/tfregulons/ in May 2019. A small script was written to add human Ensembl IDs to the data using a gene symbol to Ensembl conversion table downloaded from BioMart in May 2019.

The input and output files are located in the folder *input_data/prior_knowledge_networks/*. The script outputs a text file like the input DoRothEA network with two added column containing Ensembl IDs for the TFs and targets.

#### Code
Script: *prepare_prior_knowledge_networks/add_ensembl_ids_to_dorothea.R*

## **--Causal network generation--**

The causal networks consist of four separate levels. The cytokine and receptor levels were constructed using manually curated information on published cytokine receptors (see *Prepare prior knowledge* section). The signalling level of the networks connects cytokine receptors to transcription factors through the shortest possible paths of protein-protein interactions (PPIs). All paths consist of three or less intermediary signaling mediators making a total of six or less steps between the cytokine and the differentially expressed genes (DEGs). All proteins of the signalling level, including the cytokine receptors, are expressed in the organoid transcriptomics data for the relevant cytokine (FPKM >0 in >= 2 replicates) and in the colon dataset from the Human Protein Atlas (Uhlén et al. 2015). Signalling connections between the proteins were obtained from the OmniPath database (v0.7.111) (Türei et al. 2016). 

The transcriptional regulation level of the networks was generated by identifying and filtering transcription factors (TFs) known to regulate DEGs, which were obtained by comparing the untreated organoids to the cytokine-treated organoids for the relevant cytokine (p adj < 0.01). TF – target interactions were obtained using the published database DoRothEA v2 (Garcia-Alonso, 2018). Interactions of confidence level A-D were used. All DEGs and transcription factors are expressed in the colon dataset from the Human Protein Atlas (Uhlén et al. 2015). In addition, to reduce the size of the network and to focus on the most important regulatory interactions, transcription factors were filtered using two further criteria. Firstly, only TFs exhibiting differential expression (p adj < 0.01) were included. Secondly, we applied an internal tool to filter TFs for their influence in the network using the transcriptomics data p values and the degree of the nodes. The cut off p-corrected values < 0.1 was chosen for this analysis. This TF filtering step is carried out using an internal tool (Korcsmaros group) which is not available in this repository. 

To create the networks it is necessary to carry out the following steps in order:
1. Run the TF filtering tool on all DEGs using DoRothEA as an input network (carried out by Matthew Madgwick, Korcsmaros group).
2. Run the *network_generation.py* script to generate TF-DEG networks.
3. Run the *process_tf_filtering_output.py* script to filter the TF-DEG network to include only the most significant TFs (from the output of step 1.).
4. Run the *network_generation.py* script again, with different parameters, to import the filtered TF-TGs networks and find upstream signalling pathways.

### TF filtering (step 3)

The TF filtering script inputs the the output files of the internal TF filtering tool (used to identify the TFs with the most significant adjusted p values), the given adjusted p value to filter on and the TF-DEG networks (generated in step 2). It outputs TF-DEG networks where every TF passes the adjusted p value cut off. 

#### Code

Script: *causal_network_generation/process_tf_filtering_output.py*

### Network generation (steps 2 and 4)

This script carries out the network generation. The script must be run twice with different input settings.

First the script is run to create TF-DEG networks:
    - do_all_load, do_tfnet, do_omnipath_filter_exp, do_filter_hpa = True
    - do_tf_filt, do_tf_filt_chat, do_omnipath = False

They are then filtered externally and read into the script upon the second run through, to add the upstream signalling pathways.
    - do_all_load, do_tf_filt_chat, do_omnipath, do_omnipath_filter_exp, do_filter_hpa = True
    - do_tf_filt, do_tfnet = False

#### Code

Script: *causal_network_generation/network_generation.py*

## **--Network visualisation--** 

The Cytoscape-R interface package RCy3 is applied to programatically load the generated causal networks into Cytoscape and to carry out the majority of the visualisation.

Following this, network nodes have to be manually rearranged for visualisation in the required network levels. The networks visualisations are manually edited and saved in Cytoscape.

The script requires the cytokine-DEG networks and the processed DEG lists which are output from the 'network_generation.py' script.

#### Code

RCy3 is implemented in the script *network_visualisation/cytoscape_cytokine_deg_networks.R*

## **--Figures and summaries--**

This stage of the analysis contains a number of different scripts to summarise and/or visualise the networks. 

### Summarise networks

The first script summarises the overlap of nodes and interactions between all generated causal networks. We output a txt file with each node or interaction in the first column followed by columns for each network and a count column. A Venn diagram will also be generated indicating the number of nodes/interactions shared. The script can be run for nodes or interaction by changing the input parameters.

The second script simply counts the number of DEGs in each network and prints to screen.

The third script extract paths to TFs present in more than one network (targeted by more than one cytokine) and and combines all paths into one network with nodes labelled according to which original cytokine network they are in.

#### Code

Scripts:

1. *figures_and_summaries/combine_network_data.py*
2. *figures_and_summaries/count_degs_in_network.R*
3. *figures_and_summaries/paths_to_shared_tfs.py*

### TFs and DEGs targeted by each cytokine

Here, we extract information from the causal networks about which TFs and which DEGs are targeted by each cytokine. The first script imports the causal networks and exports a text file with the cytokine-tf/deg interactions (directly, without any of the intermediate steps). The second script imports the output from the first script, and creates from it a Venn diagram of the overlaps between the networks.

#### Code

Scripts:
1. *cytokine_to_tf_or_deg_direct.py*
2. *venn_network_tf_or_deg.py*

### Other plots

Here, there are two script to  generate plots summarising all networks at once. The chord diagram script visualise the cytokine networks as chord diagrams: cytokine-tf, cytokine-deg and tf-deg. The circos plot visualises the cytokine networks as one circos plot with each circle representing one layer of the networks.

#### Code

1. *figures_and_summaries/chord_diagrams.R*
2. *figures_and_summaries/circus_plot.R*

## **--Shared interactions--**

The combine_network_data.py (see 'Summarise networks' section) run previously, outputs a matrix-style table of which interactions are shared between the cytokine networks. 
This output file should be copied and all interactions not shared by at least 2 networks (count < 2) should be deleted from the file. Consequently this file can be imported into the cytoscape script below to create, visualise and save subnetworks where each subnetwork has all interactions shared between one combination of cytokines eg. tnfa and ifng, il13 and ifng). 

The second script carries out functional analysis on the nodes in each of the subnetworks using Reactome, KEGG and Gene Ontology Biological Processes.

#### Code

The scripts are as follows:
1. *shared_interactions/cytoscape_2_or_more_interactions_networks.R*
2. *shared_interactions/functional_analysis_shared_ints.R*

## **Functional enrichment**

This script carries out functional enrichment analysis on the DEGs targeted by each cytokine. It groups the DEGs based on which combiantion of cytokines they are targeted by in the causal networks and then carries out Reactome, KEGG and Gene Ontology Biological Processes enrichment analysis. It requires the output from the 'Cytokine_to_tf_or_deg_direct.py' script.

#### Code
*functional_enrichment/functional_enrichment_analysis.R*

## **--Colonoids vs biopsies--**

This step of the project compares the cytokine treated colonoid data (prior to network generation) to data obtained from transcriptomics on ulcerative colitis (UC) and Crohn's disease (CD) biopsies. The biopsy data is publically available (GSE16879) and was preprocessed to generate differentially expressed genes prior to running the following scripts. The first script creates chord diagram plots showing the connection/overlap of colonoid and biopsies DEGs. The second script carries out functional analysis on combinations of overlaps between the biopsy and colonoid DEGs and generates a Venn diagram of the shared/not shared DEGs.

#### Code

1. *colonoids_vs_biopsies/chord_diagram_organoids_v_biopsies_lfc.R*
2. *colonoids_vs_biopsies/biopsy_degs_functional_analysis.R*

## **--Dependencies--**

R (>= 3.4.0) with the following packages:
* dplyr (>= 3.2.0)
* ggplot2 (>= 3.2.0)
* reactomePA (>= 1.28.0)
* circlize (>= 3.12.0)
* tidyr (>= 3.1)
* stringr (>= 1.4.0)
* readxl (>= 1.3.1)
* org.Hs.eg.db (>= 3.8.2)
* clusterProfiler (>= 3.12.0)
* VennDiagram (>= 1.6.20)
* tidyverse (>= 1.2.1)
* RCy3 (>= 2.4.4)

Python (>= 3) with the following packages:
* Pandas (>= 0.24.2)
* networkx (>= 2.2)
* venn (>= 0.1.3)

## **--Authors--**

All code in this repository was written and applied by Agatha Treveil in 2019 - [agathat](https://https://github.com/agathat)

## **--Acknowledgments--**

* Nick Powell, Polychronis Pavlidis and members of the Korcsmaros lab for their guidance, support and contributions to the project.
* Cytoscape - Shannon P et al., Genome Research, 2003
* DoRothEA - Garcia-Alonso L et al., Genome Research, 2019. Static download (levels A-D) obtained from : http://saezlab.org/tfregulons/ July 2019.
* OmniPath - Turei et al., Nature Methods, 2016.

